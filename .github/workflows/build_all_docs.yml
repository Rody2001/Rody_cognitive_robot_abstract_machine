name: Build All Documentation

on:
  push:
    branches:
      - gh-pages-staging
  pull_request:
    branches:
      - main

jobs:
  krrood-doc:
    uses: ./.github/workflows/krrood/build_and_deploy_doc.yml
  
  pycram-doc:
    uses: ./.github/workflows/pycram/jupyter-book-build.yml

  semantic-digital-twin-doc:
    uses: ./.github/workflows/semantic_digital_twin/build_and_deploy_doc.yml

  probabilistic-model-doc:
    uses: ./.github/workflows/probabilistic_model/build_doc.yml

  random-events-doc:
    uses: ./.github/workflows/random_events/build_doc.yml

  deploy-all-docs:
    needs: [krrood-doc, pycram-doc, semantic-digital-twin-doc, probabilistic-model-doc, random-events-doc]
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Jupyter-Book
        run: pip install jupyter-book

      - name: Build root documentation
        run: jupyter-book build doc

      - name: Create aggregate directory
        run: |
          mkdir -p aggregate
          cp -r doc/_build/html/* aggregate/

      - name: Download krrood-doc
        uses: actions/download-artifact@v4
        with:
          name: krrood-doc
          path: aggregate/krrood

      - name: Download pycram-doc
        uses: actions/download-artifact@v4
        with:
          name: pycram-doc
          path: aggregate/pycram

      - name: Download semantic-digital-twin-doc
        uses: actions/download-artifact@v4
        with:
          name: semantic-digital-twin-doc
          path: aggregate/semantic_digital_twin

      - name: Download probabilistic-model-doc
        uses: actions/download-artifact@v4
        with:
          name: probabilistic-model-doc
          path: aggregate/probabilistic_model

      - name: Download random-events-doc
        uses: actions/download-artifact@v4
        with:
          name: random-events-doc
          path: aggregate/random_events

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: aggregate

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
